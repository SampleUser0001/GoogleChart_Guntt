<!DOCTYPE html>
<html>
<head>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript">
    google.charts.load('current', {'packages':['gantt']});
    google.charts.setOnLoadCallback(drawChart);

    let jobList = [];

    function drawChart() {
        console.info("drawChart start.")
        console.info("jobList: ", jobList)
        let data = new google.visualization.DataTable();
        data.addColumn('string', 'Task ID');
        data.addColumn('string', 'Task Name');
        data.addColumn('string', 'Time Over');
        data.addColumn('date', 'Start Date');
        data.addColumn('date', 'End Date');
        data.addColumn('number', 'Duration');
        data.addColumn('number', 'Percent Complete');
        data.addColumn('string', 'Dependencies');

        data.addRows(
            jobList.map(job => {
                return [
                    job.id,
                    job.task === undefined ? job.id : job.task,
                    job.scheduled === undefined || new Date(job.scheduled) >= new Date(job.end) ? null : "Time over",
                    new Date(job.start),
                    new Date(job.end),
                    null,
                    job.percent_complete === undefined ? 100 : job.percent_complete,
                    job.dependencies === undefined ? "" : job.dependencies.join(',')
                    
                ]
            }));

        const trackHeight = 42;
        var options = {
            guntt: {
                trackHeight: trackHeight,
            },
            height: trackHeight * (data.getNumberOfRows() + 1)
        };

        var chart = new google.visualization.Gantt(document.getElementById('chart_div'));

        chart.draw(data, options);
    }

    // TODO loadDependenciesとloadJobListを共通化する。
    
    let dependencyList = [];
    function loadDependencies() {
        const id = 'dependencies_load';
        const message = 'ジョブ依存ファイルの読み込み'
        const errorMessage = 'ジョブ依存の読み込みに失敗しました。'

        const input = document.getElementById(id);
        const filepath = input.files[0];
        console.info("filepath: ", filepath);
        if (filepath) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    dependencyList = JSON.parse(e.target.result);
                    console.info(dependencyList);
                    console.info(message + " finished.")
                } catch (e) {
                    alert(errorMessage + e);
                    console.error(e);
                    throw new Error(e);
                }
            }
            reader.readAsText(filepath);
        } else {
            const errorMessage = 'ファイルが選択されていません。';
            alert(errorMessage);
            console.error(errorMessage);
            throw new Error(errorMessage);
        }

        document.getElementById('job_load').style.visibility = 'visible';
    }

    function loadJobList() {
        const id = 'job_list_load';
        const message = 'Jobデータファイルの読み込み'
        const errorMessage = 'Jobデータファイルの読み込みに失敗しました。'

        const input = document.getElementById(id);
        const filepath = input.files[0];
        console.info("filepath: ", filepath);
        if (filepath) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    jobList = JSON.parse(e.target.result);
                    console.info(jobList);
                    (async function() {
                        await addDependencies();
                        await drawChart();
                    })();
                    console.info(message + " finished.")
                } catch (e) {
                    alert(errorMessage + e);
                    console.error(e);
                    throw new Error(e);
                }
            }
            reader.readAsText(filepath);
        } else {
            const errorMessage = 'ファイルが選択されていません。';
            alert(errorMessage);
            console.error(errorMessage);
            throw new Error(errorMessage);
        }

    }

    async function addDependencies() {
        jobList.forEach(job => {
            const dependency = dependencyList.find(dep => dep.id === job.id);
            if (dependency === undefined) {
                job.dependencies = [];
            } else {
                job.dependencies = dependency.dependencies;
            }
        });
    }

    // TODO : dependencyファイルの読み込み
    // TODO : dependencyファイルの読み込み後にジョブデータファイルを表示にする。
    // TODO : ファイル読み込みを共通化する。
</script>
</head>
<body>
    ジョブ依存ファイルを選択してください。
    <input type="file" id="dependencies_load" />
    <button id="dependencies_load_button" onclick="loadDependencies()">Load</button>
    <div id="job_load" style="visibility: hidden;">
        ジョブデータファイルを選択してください。
        <input type="file" id="job_list_load" />
        <button id="job_list_load_button" onclick="loadJobList()">Load</button>
    </div>
    <div id="chart_div"></div>
</body>
</html>
